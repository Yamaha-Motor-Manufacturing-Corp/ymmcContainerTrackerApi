@page
@using System
@using System.Linq
@model YmmcContainerTrackerApi.Pages_ReturnableContainers.IndexModel

@{
    ViewData["Title"] = "Returnable Containers";

    // Search (q)
    var q = (Request.Query["q"].ToString() ?? "").Trim();

    // Page size (pageSize)
    int pageSize;
    if (!int.TryParse(Request.Query["pageSize"], out pageSize))
        pageSize = 25;

    var allowedSizes = new[] { 25, 50, 100 };
    if (!allowedSizes.Contains(pageSize))
        pageSize = 25;

    // Page number (p)  <-- IMPORTANT: don't call this 'page'
    int p;
    if (!int.TryParse(Request.Query["p"], out p))
        p = 1;
    if (p < 1) p = 1;

    // Filter
    var filtered = string.IsNullOrWhiteSpace(q)
        ? Model.ReturnableContainers.ToList()
        : Model.ReturnableContainers.Where(x =>
            (x.ItemNo ?? "").Contains(q, StringComparison.OrdinalIgnoreCase) ||
            (x.PackingCode ?? "").Contains(q, StringComparison.OrdinalIgnoreCase) ||
            (x.PrefixCode ?? "").Contains(q, StringComparison.OrdinalIgnoreCase) ||
            (x.ContainerNumber ?? "").Contains(q, StringComparison.OrdinalIgnoreCase) ||
            (x.AlternateId ?? "").Contains(q, StringComparison.OrdinalIgnoreCase)
        ).ToList();

    // Pagination
    var totalCount = filtered.Count;
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
    if (totalPages < 1) totalPages = 1;
    if (p > totalPages) p = totalPages;

    var paged = filtered
        .Skip((p - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    // Small pager window
    var start = Math.Max(1, p - 2);
    var end = Math.Min(totalPages, p + 2);

    var fromRow = totalCount == 0 ? 0 : ((p - 1) * pageSize + 1);
    var toRow = Math.Min(p * pageSize, totalCount);
}

<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <h1 class="h3 mb-0">Returnable Containers</h1>
        <div class="text-muted">View / add / edit / delete container records</div>
    </div>

    <a asp-page="Create" class="btn btn-primary">+ Create New</a>
</div>

<hr class="my-4" />

<!-- Search + Page Size -->
<div class="d-flex flex-wrap gap-2 align-items-end mb-3">
    <form method="get" class="d-flex flex-wrap gap-2 align-items-end flex-grow-1">
        <div style="min-width: 320px;">
            <label class="form-label mb-1">Search</label>
            <input name="q"
                   value="@q"
                   class="form-control"
                   placeholder="Search Item No, Packing Code, Prefix Code, Container Number, Alternate ID..."
                   autocomplete="off" />
        </div>

        <div style="width: 170px;">
            <label class="form-label mb-1">Rows per page</label>
            <select name="pageSize" class="form-select" onchange="this.form.submit()">
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
                <option value="100" selected="@(pageSize == 100)">100</option>
            </select>
        </div>

        <!-- Reset to first page when searching/changing pageSize -->
        <input type="hidden" name="p" value="1" />

        <div class="pb-1">
            <button type="submit" class="btn btn-outline-primary">Apply</button>

            @if (!string.IsNullOrWhiteSpace(q))
            {
                <a asp-page="./Index"
                   asp-route-pageSize="@pageSize"
                   class="btn btn-outline-secondary">
                    Clear
                </a>
            }
        </div>
    </form>

    <div class="text-muted small ms-auto">
        Showing <strong>@(paged.Count)</strong> of <strong>@totalCount</strong> (filtered)
        &nbsp;|&nbsp; Page <strong>@p</strong> of <strong>@totalPages</strong>
    </div>
</div>

<!-- Scroll container (keeps horizontal scroll immediately) -->
<div class="table-shell">
    <div class="table-responsive rc-table">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ItemNo)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackingCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PrefixCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ContainerNumber)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideLength)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideWidth)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].CollapsedHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].Weight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackQuantity)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].AlternateId)</th>
                    <th class="text-end text-nowrap">Actions</th>
                </tr>
            </thead>

            <tbody>
                @if (paged.Count == 0)
                {
                    <tr>
                        <td colspan="12" class="text-center py-4 text-muted">
                            No results found for "<strong>@q</strong>"
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in paged)
                    {
                        <tr>
                            <td class="fw-semibold text-nowrap">@item.ItemNo</td>
                            <td>@item.PackingCode</td>
                            <td>@item.PrefixCode</td>
                            <td class="text-nowrap">@item.ContainerNumber</td>

                            <td class="text-end">@item.OutsideLength</td>
                            <td class="text-end">@item.OutsideWidth</td>
                            <td class="text-end">@item.OutsideHeight</td>
                            <td class="text-end">@item.CollapsedHeight</td>
                            <td class="text-end">@item.Weight</td>
                            <td class="text-end">@item.PackQuantity</td>

                            <td class="text-nowrap">@item.AlternateId</td>

                            <td class="text-end text-nowrap">
                                <a asp-page="./Edit" asp-route-id="@item.ItemNo" class="btn btn-sm btn-outline-primary">Edit</a>
                                <a asp-page="./Details" asp-route-id="@item.ItemNo" class="btn btn-sm btn-outline-secondary">Details</a>
                                <a asp-page="./Delete" asp-route-id="@item.ItemNo" class="btn btn-sm btn-outline-danger">Delete</a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination Controls -->
<nav class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
        Showing <strong>@fromRow</strong> - <strong>@toRow</strong> of <strong>@totalCount</strong>
    </div>

    <ul class="pagination mb-0">
        <li class="page-item @(p > 1 ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p - 1)">Prev</a>
        </li>

        @if (start > 1)
        {
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="1">1</a>
            </li>
            @if (start > 2)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
        }

        @for (var i = start; i <= end; i++)
        {
            <li class="page-item @(i == p ? "active" : "")">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@i">@i</a>
            </li>
        }

        @if (end < totalPages)
        {
            @if (end < totalPages - 1)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@totalPages">@totalPages</a>
            </li>
        }

        <li class="page-item @(p < totalPages ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p + 1)">Next</a>
        </li>
    </ul>
</nav>

<style>
    .table-shell {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: .5rem;
        overflow: hidden;
        background: #fff;
    }

    .rc-table {
        max-height: calc(100vh - 390px);
        overflow: auto; /* x + y scroll */
    }

        .rc-table thead th {
            position: sticky;
            top: 0;
            z-index: 2;
        }

    .table td, .table th {
        padding: 0.75rem 0.9rem;
        vertical-align: middle;
    }

    .table-bordered > :not(caption) > * > * {
        border-width: 1px;
    }
</style>
