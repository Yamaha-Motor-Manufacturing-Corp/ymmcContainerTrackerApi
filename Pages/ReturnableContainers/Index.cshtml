@page
@using System
@using System.Linq
@model YmmcContainerTrackerApi.Pages_ReturnableContainers.IndexModel

@{
    ViewData["Title"] = "Returnable Containers";

    // Read query params
    var q = (Request.Query["q"].ToString() ?? "").Trim();

    // Page size (allowed: 25, 50, 100)
    int pageSize;
    if (!int.TryParse(Request.Query["pageSize"], out pageSize))
        pageSize = 25;
    var allowedSizes = new[] { 25, 50, 100 };
    if (!allowedSizes.Contains(pageSize))
        pageSize = 25;

    // Page number
    int p;
    if (!int.TryParse(Request.Query["p"], out p))
        p = 1;
    if (p < 1) p = 1;

    // Parse multi-term search (split by | or tab)
    var searchTerms = string.IsNullOrWhiteSpace(q)
        ? new List<string>()
        : q.Split(new[] { '|', '\t' }, StringSplitOptions.RemoveEmptyEntries)
           .Select(t => t.Trim())
           .Where(t => !string.IsNullOrWhiteSpace(t))
           .ToList();

    // Filter: any term matches any field (case-insensitive, partial)
    var filtered = searchTerms.Count == 0
        ? Model.ReturnableContainers.ToList()
        : Model.ReturnableContainers.Where(x =>
            searchTerms.Any(term =>
                (x.ItemNo ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (x.PackingCode ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (x.PrefixCode ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (x.ContainerNumber ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (x.AlternateId ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase)
            )
        ).ToList();

    // Pagination math
    var totalCount = filtered.Count;
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
    if (totalPages < 1) totalPages = 1;
    if (p > totalPages) p = totalPages;

    // Page slice
    var paged = filtered
        .Skip((p - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    // Pagination window
    var start = Math.Max(1, p - 2);
    var end = Math.Min(totalPages, p + 2);

    // Row range for display
    var fromRow = totalCount == 0 ? 0 : ((p - 1) * pageSize + 1);
    var toRow = Math.Min(p * pageSize, totalCount);
}

<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <h1 class="h3 mb-0">Returnable Containers</h1>
        <div class="text-muted">
            @if (Model.CanEdit)
            {
                <span>View / add / edit / delete container records</span>
            }
            else
            {
                <span>View container records (read-only)</span>
            }
        </div>
    </div>

    <a asp-page="Create" class="btn btn-primary">+ Create New</a>
</div>

<hr class="my-4" />

<!-- Search + Page Size -->
<div class="d-flex flex-wrap gap-2 align-items-end mb-3">
    <form method="get" class="d-flex flex-wrap gap-2 align-items-end flex-grow-1">
        <div style="min-width: 320px;">
            <label class="form-label mb-1">Search</label>
            <!-- Multi-term search: use | or tab; searches multiple fields -->
            <input name="q"
                   value="@q"
                   class="form-control"
                   placeholder="Search Item No, Packing Code, Prefix Code, Container Number, Alternate ID..."
                   autocomplete="off" />
        </div>

        <div style="width: 170px;">
            <label class="form-label mb-1">Rows per page</label>
            <select name="pageSize" class="form-select" onchange="this.form.submit()">
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
                <option value="100" selected="@(pageSize == 100)">100</option>
            </select>
        </div>

        <!-- Always reset to page 1 when applying filters -->
        <input type="hidden" name="p" value="1" />

        <div class="pb-1">
            <button type="submit" class="btn btn-outline-primary">Apply</button>

            @if (!string.IsNullOrWhiteSpace(q))
            {
                <!-- Clear search, keep page size -->
                <a asp-page="./Index"
                   asp-route-pageSize="@pageSize"
                   class="btn btn-outline-secondary">
                    Clear
                </a>
            }
        </div>
    </form>

    <div class="text-muted small ms-auto">
        Showing <strong>@(paged.Count)</strong> of <strong>@totalCount</strong> (filtered)
        &nbsp;|&nbsp; Page <strong>@p</strong> of <strong>@totalPages</strong>
    </div>
</div>

<!-- Table -->
<div class="table-shell">
    <div class="table-responsive rc-table">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="text-end text-nowrap">Actions</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ItemNo)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackingCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PrefixCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ContainerNumber)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideLength)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideWidth)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].CollapsedHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].Weight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackQuantity)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].AlternateId)</th>
                </tr>
            </thead>

            <tbody>
                @if (paged.Count == 0)
                {
                    <tr>
                        <td colspan="12" class="text-center py-4 text-muted">
                            No results found for "<strong>@q</strong>"
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in paged)
                    {
                        @await Html.PartialAsync("_Row", new YmmcContainerTrackerApi.Models.ReturnableContainersRowModel { Item = item, IsEditing = false })
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<nav class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
        Showing <strong>@fromRow</strong> - <strong>@toRow</strong> of <strong>@totalCount</strong>
    </div>

    <ul class="pagination mb-0">
        <!-- Prev -->
        <li class="page-item @(p > 1 ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p - 1)">Prev</a>
        </li>

        <!-- First page shortcut -->
        @if (start > 1)
        {
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="1">1</a>
            </li>
            @if (start > 2)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
        }

        <!-- Window around current page -->
        @for (var i = start; i <= end; i++)
        {
            <li class="page-item @(i == p ? "active" : "")">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@i">@i</a>
            </li>
        }

        <!-- Last page shortcut -->
        @if (end < totalPages)
        {
            @if (end < totalPages - 1)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@totalPages">@totalPages</a>
            </li>
        }

        <!-- Next -->
        <li class="page-item @(p < totalPages ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p + 1)">Next</a>
        </li>
    </ul>
</nav>

@section Scripts {
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
}

<style>
    .table-shell {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: .5rem;
        overflow: hidden;
        background: #fff;
    }

    .rc-table {
        max-height: calc(100vh - 390px);
        overflow-y: auto;     
        overflow-x: hidden;    
    }

        .rc-table thead th {
            position: sticky;
            top: 0;
            z-index: 2;
        }

    .table td, .table th {
        padding: 0.2rem 0.25rem;
        vertical-align: middle;
        font-size: 0.68rem;
        line-height: 1.1;
        white-space: nowrap;
    }

    .table-bordered > :not(caption) > * > * {
        border-width: 1px;
    }
</style>
