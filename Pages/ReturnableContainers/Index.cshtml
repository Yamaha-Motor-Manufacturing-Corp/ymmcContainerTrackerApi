@page
@using System
@using System.Linq
@model YmmcContainerTrackerApi.Pages_ReturnableContainers.IndexModel

@{
    ViewData["Title"] = "Returnable Containers";

    // ========================================
    // SEARCH QUERY PARAMETER EXTRACTION
    // ========================================
    // Extract the search query from URL query string parameter "q"
    // Example: /ReturnableContainers?q=YPB-4424-25
    // Trim() removes leading/trailing whitespace from user input
    var q = (Request.Query["q"].ToString() ?? "").Trim();

    // ========================================
    // PAGE SIZE CONFIGURATION
    // ========================================
    // Extract page size from URL query string parameter "pageSize"
    // Default to 25 if not provided or invalid
    int pageSize;
    if (!int.TryParse(Request.Query["pageSize"], out pageSize))
        pageSize = 25;

    // Validate page size against allowed values (25, 50, 100)
    // This prevents users from requesting excessive rows (e.g., ?pageSize=999999)
    var allowedSizes = new[] { 25, 50, 100 };
    if (!allowedSizes.Contains(pageSize))
        pageSize = 25;

    // ========================================
    // PAGE NUMBER EXTRACTION
    // ========================================
    // Extract current page number from URL query string parameter "p"
    // Example: /ReturnableContainers?p=3 shows page 3
    // Default to page 1 if not provided or invalid
    // NOTE: Using "p" instead of "page" to avoid Razor Pages routing conflicts
    int p;
    if (!int.TryParse(Request.Query["p"], out p))
        p = 1;
    if (p < 1) p = 1;

    // ========================================
    // MULTI-TERM SEARCH PARSING
    // ========================================
    // Split the search query on pipe (|) and tab characters
    // This allows users to copy-paste from the table (e.g., "YPB-4424-25 | 3J")
    // and still find results by searching for individual terms
    //
    // Example input: "YPB-4424-25 | 3J"
    // Result: ["YPB-4424-25", "3J"]
    //
    // Benefits:
    // - Users can paste entire row content from Excel/table
    // - Each term is searched independently (OR logic)
    // - Handles whitespace gracefully with Trim()
    var searchTerms = string.IsNullOrWhiteSpace(q) 
        ? new List<string>()  // Empty search = no filter
        : q.Split(new[] { '|', '\t' }, StringSplitOptions.RemoveEmptyEntries)  // Split on | and tabs
           .Select(t => t.Trim())                                               // Remove whitespace from each term
           .Where(t => !string.IsNullOrWhiteSpace(t))                          // Exclude empty terms
           .ToList();

    // ========================================
    // MULTI-FIELD SEARCH FILTER
    // ========================================
    // Filter containers based on search terms
    // Logic: If ANY search term matches ANY field, include the record
    //
    // Searchable fields:
    // - ItemNo (e.g., "YPB-4424-25")
    // - PackingCode (e.g., "3J")
    // - PrefixCode (e.g., "YPB")
    // - ContainerNumber (e.g., "4424-25")
    // - AlternateId (custom identifiers)
    //
    // Features:
    // - Case-insensitive search (OrdinalIgnoreCase)
    // - Trims database values to handle trailing spaces
    // - Uses .Contains() for partial matching (not exact match required)
    //
    // Example: Search "YPB | 3J" will find:
    // - All records with ItemNo containing "YPB"
    // - All records with PackingCode containing "3J"
    var filtered = searchTerms.Count == 0
        ? Model.ReturnableContainers.ToList()  // No search terms = show all
        : Model.ReturnableContainers.Where(x =>
            searchTerms.Any(term =>  // Check if ANY term matches...
                (x.ItemNo ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||           // Item number
                (x.PackingCode ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||     // Packing code
                (x.PrefixCode ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) ||      // Prefix code
                (x.ContainerNumber ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase) || // Container number
                (x.AlternateId ?? "").Trim().Contains(term, StringComparison.OrdinalIgnoreCase)        // Alternate ID
            )
        ).ToList();

    // ========================================
    // PAGINATION CALCULATIONS
    // ========================================
    // Calculate total pages based on filtered results
    var totalCount = filtered.Count;
    var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
    if (totalPages < 1) totalPages = 1;  // Always show at least 1 page
    if (p > totalPages) p = totalPages;  // Prevent requesting page beyond last page

    // Get the current page's records using Skip/Take
    // Example: Page 2 with 25 rows per page → Skip(25).Take(25)
    var paged = filtered
        .Skip((p - 1) * pageSize)  // Skip records from previous pages
        .Take(pageSize)             // Take only the current page's records
        .ToList();

    
    // PAGINATION 
    
    var start = Math.Max(1, p - 2);
    var end = Math.Min(totalPages, p + 2);    

    // Calculate row numbers for "Showing X - Y of Z" display
    var fromRow = totalCount == 0 ? 0 : ((p - 1) * pageSize + 1);  // First row on current page
    var toRow = Math.Min(p * pageSize, totalCount);                // Last row on current page
}

<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        <h1 class="h3 mb-0">Returnable Containers</h1>
        <div class="text-muted">View / add / edit / delete container records</div>
    </div>

    <a asp-page="Create" class="btn btn-primary">+ Create New</a>
</div>

<hr class="my-4" />

<!-- Search + Page Size -->
<div class="d-flex flex-wrap gap-2 align-items-end mb-3">
    <form method="get" class="d-flex flex-wrap gap-2 align-items-end flex-grow-1">
        <div style="min-width: 320px;">
            <label class="form-label mb-1">Search</label>
            <!-- 
                SEARCH INPUT:
                - Supports multi-term search (separate with | or tab)
                - Searches across: ItemNo, PackingCode, PrefixCode, ContainerNumber, AlternateId
                - Case-insensitive partial matching
                - Users can paste table row content (e.g., "YPB-4424-25 | 3J")
            -->
            <input name="q"
                   value="@q"
                   class="form-control"
                   placeholder="Search Item No, Packing Code, Prefix Code, Container Number, Alternate ID..."
                   autocomplete="off" />
        </div>

        <div style="width: 170px;">
            <label class="form-label mb-1">Rows per page</label>
            <select name="pageSize" class="form-select" onchange="this.form.submit()">
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
                <option value="100" selected="@(pageSize == 100)">100</option>
            </select>
        </div>

        <!-- Reset to first page when searching/changing pageSize -->
        <!-- This prevents showing "page 10" when search results only have 1 page -->
        <input type="hidden" name="p" value="1" />

        <div class="pb-1">
            <button type="submit" class="btn btn-outline-primary">Apply</button>

            @if (!string.IsNullOrWhiteSpace(q))
            {
                <!-- Clear button: Resets search but preserves page size preference -->
                <a asp-page="./Index"
                   asp-route-pageSize="@pageSize"
                   class="btn btn-outline-secondary">
                    Clear
                </a>
            }
        </div>
    </form>

    <div class="text-muted small ms-auto">
        Showing <strong>@(paged.Count)</strong> of <strong>@totalCount</strong> (filtered)
        &nbsp;|&nbsp; Page <strong>@p</strong> of <strong>@totalPages</strong>
    </div>
</div>

<!-- Scroll container (keeps horizontal scroll immediately) -->
<div class="table-shell">
    <div class="table-responsive rc-table">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th class="text-end text-nowrap">Actions</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ItemNo)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackingCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PrefixCode)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].ContainerNumber)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideLength)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideWidth)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].OutsideHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].CollapsedHeight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].Weight)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].PackQuantity)</th>
                    <th class="text-nowrap">@Html.DisplayNameFor(model => model.ReturnableContainers[0].AlternateId)</th>
                </tr>
            </thead>

            <tbody>
                @if (paged.Count == 0)
                {
                    <tr>
                        <td colspan="12" class="text-center py-4 text-muted">
                            No results found for "<strong>@q</strong>"
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in paged)
                    {
                        @await Html.PartialAsync("_Row", new YmmcContainerTrackerApi.Models.ReturnableContainersRowModel { Item = item, IsEditing = false })
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination Controls -->
<nav class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
        Showing <strong>@fromRow</strong> - <strong>@toRow</strong> of <strong>@totalCount</strong>
    </div>

    <ul class="pagination mb-0">
        <!-- Previous Page Button -->
        <li class="page-item @(p > 1 ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p - 1)">Prev</a>
        </li>

        <!-- Show page 1 if not in current window -->
        @if (start > 1)
        {
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="1">1</a>
            </li>
            @if (start > 2)
            {
                <!-- Ellipsis to indicate skipped pages -->
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
        }

        <!-- Page number buttons (current ± 2 pages) -->
        @for (var i = start; i <= end; i++)
        {
            <li class="page-item @(i == p ? "active" : "")">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@i">@i</a>
            </li>
        }

        <!-- Show last page if not in current window -->
        @if (end < totalPages)
        {
            @if (end < totalPages - 1)
            {
                <!-- Ellipsis to indicate skipped pages -->
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
            <li class="page-item">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-q="@q"
                   asp-route-pageSize="@pageSize"
                   asp-route-p="@totalPages">@totalPages</a>
            </li>
        }

        <!-- Next Page Button -->
        <li class="page-item @(p < totalPages ? "" : "disabled")">
            <a class="page-link"
               asp-page="./Index"
               asp-route-q="@q"
               asp-route-pageSize="@pageSize"
               asp-route-p="@(p + 1)">Next</a>
        </li>
    </ul>
</nav>

@section Scripts {
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
}

<style>
    .table-shell {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: .5rem;
        overflow: hidden;
        background: #fff;
    }

    .rc-table {
        max-height: calc(100vh - 390px);
        overflow: auto; /* x + y scroll */
    }

        .rc-table thead th {
            position: sticky;
            top: 0;
            z-index: 2;
        }

    .table td, .table th {
        padding: 0.75rem 0.9rem;
        vertical-align: middle;
    }

    .table-bordered > :not(caption) > * > * {
        border-width: 1px;
    }
</style>
